<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Domanda o VeritÃ  â€“ Invito</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css?v=1_0_0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js?v=1_0_0"></script>
  <script src="firebase-init.js?v=1_0_0"></script>
  <script src="common.js?v=1_0_0"></script>
</head>
<body>
  <div class="version">MVP v1.0.0 â€“ Invito</div>
  <main>
    <section class="panel">
      <h1>Crea una partita</h1>
      <p>Inserisci il tuo nome per generare un link d'invito.</p>
      <input id="creatorName" placeholder="Il tuo nome">
      <button id="createBtn" disabled class="bigBtn">Genera Invito</button>
      <div id="status" class="muted"></div>
    </section>

    <section id="links" class="panel" style="display:none">
      <h2>Link</h2>
      <p><strong>Link per l'avversario:</strong></p>
      <div class="row">
        <input id="opponentLink" readonly>
        <button id="copyOpp">ðŸ“‹ Copia</button>
      </div>
      <p><strong>Il tuo link (host):</strong></p>
      <div class="row">
        <input id="hostLink" readonly>
        <button id="copyHost">ðŸ“‹ Copia</button>
      </div>
      <p class="muted">Invia il primo link all'avversario. Quando accetta, verrai portato alla scelta carte.</p>
    </section>
  </main>

  <script>
  (function(){
    const {qs, toast, copy, randId, getCID} = DV;
    const cid = getCID();
    const nameEl = qs('#creatorName');
    const btn = qs('#createBtn');
    const status = qs('#status');
    nameEl.addEventListener('input', ()=>{ btn.disabled = nameEl.value.trim().length<2; });

    btn.addEventListener('click', async ()=>{
      const name = nameEl.value.trim(); if(!name) return;
      const gid = randId();
      const base = location.origin + location.pathname.replace(/index\.html?$/i,'');
      const oppLink = base + 'join.html?game='+gid;
      const hostLink = base + 'index.html?host='+gid;
      // write session
      try{
        await DB.ref('games/'+gid).set({
          version: 'mvp_1_0_0',
          createdAt: Date.now(),
          phase: 'waiting',
          player1: { name, clientId: cid, role:'p1', joined:true }
        });
        status.textContent = 'Sessione creata. In attesa dell\'avversarioâ€¦';
        // show links
        qs('#links').style.display='block';
        qs('#opponentLink').value = oppLink;
        qs('#hostLink').value = hostLink;
        qs('#copyOpp').onclick = ()=>copy(oppLink);
        qs('#copyHost').onclick = ()=>copy(hostLink);
        history.replaceState(null,'', 'index.html?host='+gid);
        // listen for accept
        DB.ref('games/'+gid).on('value', snap=>{
          const d = snap.val();
          if(!d) { status.textContent='Sessione non trovata'; return; }
          if(d.player2 && d.player2.joined){
            status.textContent = 'Avversario ha accettato! Vai alla scelta carteâ€¦';
            location.href = 'select.html?game='+gid+'&role=p1';
          }
        });
      }catch(e){
        status.textContent = 'Errore: '+e.message;
      }
    });
  })();
  </script>
</body>
</html>
