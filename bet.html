<!DOCTYPE html><html lang='it'><head><meta charset='UTF-8'><title>Puntata</title><meta name='viewport' content='width=device-width, initial-scale=1'><link rel='stylesheet' href='style.css?v=1_1_2'><script src='https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js'></script><script src='https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js'></script><script src='firebase-config.js?v=1_1_0'></script><script src='firebase-init.js?v=1_1_0'></script><script src='common.js?v=1_1_0'></script><style>.version{position:sticky;top:0;background:#1f6feb;color:#fff;text-align:center;padding:6px;font-weight:700}</style></head><body><div class='version'>MVP v1.1.2 – Puntata (safe)</div><main><section class='panel'><h2>Punta i tuoi token – Turno <span id='turn'>1</span></h2><div class='row'><div><strong>I tuoi token:</strong> <span id='myTok'>—</span></div><div id='oppWarn' class='badge' style='display:none'>Avversario &lt; 6</div></div><div>Tempo: <span id='t'>15</span>s</div><div class='row'><div style='flex:1'><label for='sel'>Seleziona puntata</label><select id='sel' disabled></select></div><div><button id='btn0' class='secondary bigBtn' disabled>Punta 0</button></div></div><div id='status' class='muted'></div></section><section id='out' class='panel' style='display:none'><h2>Esito turno</h2><div id='outTxt'></div><div id='outAct'></div></section></main><script>(function(){const {qs,params,now}=DV;const gid=params().get('game');const role=params().get('role');const tEl=qs('#t'),turnEl=qs('#turn'),myTokEl=qs('#myTok'),status=qs('#status'),sel=qs('#sel'),btn0=qs('#btn0');const out=qs('#out'),outTxt=qs('#outTxt'),outAct=qs('#outAct'),oppWarn=qs('#oppWarn');function fillSelect(max){sel.innerHTML='<option value=""></option>';for(let i=0;i<=max;i++){const o=document.createElement('option');o.value=o.textContent=i;sel.appendChild(o);}}let local={deadline:0};DB.ref('games/'+gid).on('value',async s=>{const d=s.val()||{};if(d.phase==='outcome'){return showOutcome(d);}if(d.phase!=='betting')return;const turn=d.turn||1;turnEl.textContent=turn;const needTokens=typeof d.tokens_p1!=='number'||typeof d.tokens_p2!=='number';const needDeadline=typeof d.betDeadlineAt!=='number';const roundKey='turn_'+String(turn);const roundExists=d.rounds&&d.rounds[roundKey];if((needTokens||needDeadline)&&!roundExists){await DB.ref('games/'+gid).transaction(data=>{if(!data||data.phase!=='betting')return data;const curTurn=data.turn||1;const rk='turn_'+String(curTurn);if(data.rounds&&data.rounds[rk])return data;if(typeof data.tokens_p1!=='number')data.tokens_p1=10;if(typeof data.tokens_p2!=='number')data.tokens_p2=10;if(typeof data.betDeadlineAt!=='number')data.betDeadlineAt=Date.now()+15000;data.bets=data.bets||{};data.roundResolved=false;return data;});}const myTok=role==='p1'?d.tokens_p1:d.tokens_p2;const oppTok=role==='p1'?d.tokens_p2:d.tokens_p1;myTokEl.textContent=(typeof myTok==='number')?myTok:'—';oppWarn.style.display=(typeof oppTok==='number'&&oppTok<6)?'inline-block':'none';if(typeof myTok==='number'){fillSelect(myTok);sel.disabled=false;btn0.disabled=false;}if(typeof d.betDeadlineAt==='number'){local.deadline=d.betDeadlineAt;}function drawTimer(){const r=Math.max(0,Math.floor((local.deadline-now())/1000));tEl.textContent=r;if(r<=0){sel.disabled=true;btn0.disabled=true;}}drawTimer();setInterval(drawTimer,250);});sel.addEventListener('change',()=>{const v=parseInt(sel.value||'0',10)||0;DB.ref('games/'+gid+'/bets/'+role).set(v);status.textContent='Puntata: '+v;});btn0.addEventListener('click',()=>{sel.value='0';sel.dispatchEvent(new Event('change'));});function showOutcome(d){sel.disabled=true;btn0.disabled=true;out.style.display='block';const turn=d.turn||1;const r=d.rounds&&d.rounds['turn_'+turn];if(!r){outTxt.textContent='Esito non disponibile.';return;}if(r.winner===null){outTxt.textContent='Pareggio. Entrambi perdono le puntate.';const btn=document.createElement('button');btn.textContent='Prossimo turno';btn.onclick=()=>{DB.ref('games/'+gid).transaction(data=>{if(!data||data.phase!=='outcome')return data;data.turn=(data.turn||1)+1;data.tokens_p1=(data.tokens_p1||0)+2;data.tokens_p2=(data.tokens_p2||0)+2;data.bets={};data.roundResolved=false;data.phase='betting';data.betDeadlineAt=Date.now()+15000;return data;});};outAct.innerHTML='';outAct.appendChild(btn);}else{outTxt.textContent='Ha vinto: '+(r.winner==='p1'?(d.player1?.name||'Giocatore 1'):(d.player2?.name||'Giocatore 2'));const btn=document.createElement('button');btn.textContent='Vai alla Fase Azione';btn.onclick=()=>{DB.ref('games/'+gid+'/phase').set('action');location.href='action.html?game='+gid+'&role='+role;};outAct.innerHTML='';outAct.appendChild(btn);}}})();</script></body></html>