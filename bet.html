<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Domanda o Verità – Puntata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css?v=1_0_0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js?v=1_0_0"></script>
  <script src="firebase-init.js?v=1_0_0"></script>
  <script src="common.js?v=1_0_0"></script>
  <style>
    :root{--bg:#0d1117;--panel:#161b22;--border:#30363d;--accent:#1f6feb;--text:#c9d1d9}
    body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;margin:0}
    .version{position:sticky;top:36px;background:var(--accent);color:#fff;text-align:center;padding:6px 10px;font-weight:700;z-index:5}
    main{max-width:900px;margin:24px auto;padding:0 16px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .bigBtn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:#238636;color:#fff;font-weight:600}
    .secondary{background:#30363d}
    .muted{opacity:.8}
    select, input{background:#0d1117;color:#c9d1d9;border:1px solid #30363d;border-radius:8px;padding:8px}
    #dbg{position:sticky;top:0;z-index:20;background:#24292f;color:#fff;padding:6px 8px;font:12px/1.2 system-ui,Segoe UI,Roboto}
    #dbg .pill{display:inline-block;background:#444;padding:2px 6px;border-radius:6px;margin-right:6px}
  </style>
</head>
<body>
  <div id="dbg">
    <span class="pill">bet v1.0.0-SW</span>
    <span class="pill">gid=<span id="dbg_gid">?</span></span>
    <span class="pill">role=<span id="dbg_role">?</span></span>
    <span class="pill">phase=<span id="dbg_phase">?</span></span>
    <span class="pill">turn=<span id="dbg_turn">?</span></span>
  </div>
  <div class="version">MVP v1.0.0 – Puntata (single-writer)</div>

  <main>
    <section class="panel" id="betPanel">
      <h2>Punta i tuoi token – Turno <span id="turn">—</span></h2>
      <div class="row">
        <div><strong>I tuoi token:</strong> <span id="myTok">—</span></div>
        <div id="oppWarn" class="muted" style="display:none">Avversario &lt; 6</div>
      </div>
      <div>Tempo: <span id="t">15</span>s</div>
      <div class="row" style="margin-top:8px">
        <div style="flex:1 1 220px">
          <label for="sel">Seleziona puntata</label>
          <select id="sel" disabled></select>
        </div>
        <div><button id="btn0" class="secondary bigBtn" disabled>Punta 0</button></div>
      </div>
      <div id="status" class="muted" style="margin-top:6px"></div>
    </section>

    <section id="outcomePanel" class="panel" style="display:none">
      <h2>Esito turno</h2>
      <div id="outTxt"></div>
      <div id="outAct" style="margin-top:8px"></div>
    </section>

    <section id="revealPanel" class="panel" style="display:none">
      <h2>Domanda & Risposta</h2>
      <div id="revealQ"></div>
      <div id="revealA" class="muted"></div>
      <div class="muted">Nuovo turno tra <span id="revTimer">20</span>s…</div>
    </section>
  </main>

<script>
(function(){
  const {qs, params, now} = DV;
  const gid=params().get('game'); const role=params().get('role');
  const dbg_gid=qs('#dbg_gid'), dbg_role=qs('#dbg_role'), dbg_phase=qs('#dbg_phase'), dbg_turn=qs('#dbg_turn');
  dbg_gid.textContent=gid||'(manca)'; dbg_role.textContent=role||'(manca)';

  const tEl=qs('#t'), turnEl=qs('#turn'), myTokEl=qs('#myTok'), status=qs('#status'), sel=qs('#sel'), btn0=qs('#btn0');
  const oppWarn=qs('#oppWarn');
  const outcomePanel=qs('#outcomePanel'), outTxt=qs('#outTxt'), outAct=qs('#outAct');
  const betPanel=qs('#betPanel');
  const revealPanel=qs('#revealPanel'), revQ=qs('#revealQ'), revA=qs('#revealA'), revTimer=qs('#revTimer');

  let local={deadline:0}; let tick=null, resolveTick=null, revTick=null, resolved=false;

  function fillSelect(max){
    sel.innerHTML='<option value=""></option>';
    for(let i=0;i<=max;i++){ const o=document.createElement('option'); o.value=o.textContent=i; sel.appendChild(o); }
  }
  function inferNextTurn(rounds){
    if(!rounds) return 1;
    let maxT=0; Object.keys(rounds).forEach(k=>{ const m=/^turn_(\d+)$/.exec(k); if(m){ const n=parseInt(m[1],10); if(n>maxT) maxT=n; } });
    return maxT+1;
  }

  // Redirect to action page when phase='action' (both devices)
  DB.ref('games/'+gid+'/phase').on('value', snap=>{
    const ph=snap.val(); dbg_phase.textContent = ph || '(manca)';
    if(ph==='action'){
      location.href='action.html?game='+gid+'&role='+role;
    }
  });

  DB.ref('games/'+gid).on('value', s=>{
    const d=s.val()||{}; dbg_turn.textContent=(typeof d.turn==='number')?d.turn:'(?)';

    // Handle reveal here: single-writer advances after reveal ends
    if(d.phase==='action_reveal'){
      betPanel.style.display='none'; outcomePanel.style.display='none'; revealPanel.style.display='block';
      const act=d.action||{};
      revQ.textContent='Domanda: '+(act.questionText||'(n/a)');
      revA.textContent='Risposta: '+(act.answer||'(n/a)');
      const end = (typeof act.revealUntil==='number')? act.revealUntil : (Date.now()+20000);
      function drawRev(){ const r=Math.max(0,Math.floor((end - Date.now())/1000)); revTimer.textContent=r; if(r<=0){ clearInterval(revTick); advanceFromReveal(); } }
      if(revTick) clearInterval(revTick); revTick=setInterval(drawRev,250); drawRev();
      return;
    }

    if(d.phase==='outcome'){ showOutcome(d); return; }
    if(d.phase!=='betting'){ return; }

    // Ensure deadline exists (don't touch tokens/turn here)
    if(typeof d.betDeadlineAt!=='number'){
      DB.ref('games/'+gid+'/betDeadlineAt').set(Date.now()+15000);
      return;
    }

    // render betting
    betPanel.style.display='block'; outcomePanel.style.display='none'; revealPanel.style.display='none';
    turnEl.textContent=d.turn || inferNextTurn(d.rounds||{});
    const myTok = role==='p1'? d.tokens_p1 : d.tokens_p2;
    const oppTok = role==='p1'? d.tokens_p2 : d.tokens_p1;
    myTokEl.textContent=(typeof myTok==='number')?myTok:'—';
    oppWarn.style.display = (typeof oppTok==='number' && oppTok<6) ? 'inline-block' : 'none';
    if(typeof myTok==='number'){ fillSelect(myTok); sel.disabled=false; btn0.disabled=false; }

    local.deadline = d.betDeadlineAt;
    function draw(){
      const r=Math.max(0,Math.floor((local.deadline - now())/1000));
      tEl.textContent=r; if(r<=0){ sel.disabled=true; btn0.disabled=true; }
    }
    draw(); if(tick) clearInterval(tick); tick=setInterval(draw,200);

    if(resolveTick) clearInterval(resolveTick);
    resolveTick=setInterval(()=>{
      const r=Math.max(0,Math.floor((local.deadline - now())/1000));
      if(!resolved && r<=0){ resolved=true; resolveRound(); }
    },400);
  });

  sel.addEventListener('change', ()=>{ const v=parseInt(sel.value||'0',10)||0; DB.ref('games/'+gid+'/bets/'+role).set(v); status.textContent='Puntata: '+v; });
  btn0.addEventListener('click', ()=>{ sel.value='0'; sel.dispatchEvent(new Event('change')); });

  function resolveRound(){
    DB.ref('games/'+gid').transaction(data=>{
      if(!data || data.phase!=='betting' || data.roundResolved) return data;
      const b1=parseInt(data.bets?.p1||0,10)||0, b2=parseInt(data.bets?.p2||0,10)||0;
      const t1=parseInt(data.tokens_p1||10,10)||10, t2=parseInt(data.tokens_p2||10,10)||10;
      const cb1=Math.min(b1,t1), cb2=Math.min(b2,t2);
      data.tokens_p1=t1-cb1; data.tokens_p2=t2-cb2;
      let winner=null; if(cb1>cb2) winner='p1'; else if(cb2>cb1) winner='p2'; else winner=null;
      const turn=(typeof data.turn==='number' && data.turn>=1)?data.turn:inferNextTurn(data.rounds||{});
      data.rounds=data.rounds||{}; data.rounds['turn_'+turn]={ bet_p1:cb1, bet_p2:cb2, winner };
      data.lastWinner=winner; data.winnerRole=winner; data.roundResolved=true; data.phase='outcome'; data.betDeadlineAt=null;
      return data;
    });
  }

  function showOutcome(d){
    if(tick) clearInterval(tick); if(resolveTick) clearInterval(resolveTick);
    sel.disabled=true; btn0.disabled=true;
    betPanel.style.display='none'; revealPanel.style.display='none'; outcomePanel.style.display='block';

    const turn=d.turn||(inferNextTurn(d.rounds||{})-1);
    const r=d.rounds && d.rounds['turn_'+turn];
    if(!r){ outTxt.textContent='Esito non disponibile.'; outAct.innerHTML=''; return; }

    if(r.winner===null){
      outTxt.textContent='Pareggio. Entrambi perdono le puntate.';
      const btn=document.createElement('button'); btn.textContent='Prossimo turno';
      btn.onclick=()=>{
        DB.ref('games/'+gid).transaction(data=>{
          if(!data || data.phase!=='outcome') return data;
          data.turn = (typeof data.turn==='number' && data.turn>=1) ? data.turn+1 : (inferNextTurn(data.rounds||{}));
          data.tokens_p1=(data.tokens_p1||0)+2; data.tokens_p2=(data.tokens_p2||0)+2;
          data.bets={}; data.roundResolved=false; data.phase='betting'; data.betDeadlineAt=Date.now()+15000;
          return data;
        });
      };
      outAct.innerHTML=''; outAct.appendChild(btn);
    } else {
      outTxt.textContent='Ha vinto: '+(r.winner==='p1'?(d.player1?.name||'Giocatore 1'):(d.player2?.name||'Giocatore 2'));
      const btn=document.createElement('button'); btn.textContent='Vai alla Fase Domanda';
      btn.onclick=()=>{
        DB.ref('games/'+gid+'/phase').set('action');
      };
      outAct.innerHTML=''; outAct.appendChild(btn);
    }
  }

  async function advanceFromReveal(){
    await DB.ref('games/'+gid).transaction(data=>{
      if(!data || data.phase!=='action_reveal') return data;
      const cur = (typeof data.turn==='number' && data.turn>=1) ? data.turn : (inferNextTurn(data.rounds||{}));
      data.turn = cur + 1;
      data.tokens_p1=(data.tokens_p1||0)+2;
      data.tokens_p2=(data.tokens_p2||0)+2;
      data.bets={};
      data.roundResolved=false;
      data.lastWinner=null;
      data.winnerRole=null;
      data.phase='betting';
      data.betDeadlineAt=Date.now()+15000;
      data.action=null;
      return data;
    });
  }

})();
</script>
</body>
</html>
