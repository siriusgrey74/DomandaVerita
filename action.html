<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Domanda o Verità – Azione</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css?v=1_0_0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js?v=1_0_0"></script>
  <script src="firebase-init.js?v=1_0_0"></script>
  <script src="common.js?v=1_0_0"></script>
</head>
<body>
  <div class="version">MVP v1.0.0 – Azione</div>
  <main>
    <section class="panel">
      <h2>Fase Azione</h2>
      <div id="info" class="muted">Caricamento…</div>
      <div id="winnerUI" style="display:none">
        <p>Hai vinto la puntata. Scegli:</p>
        <div class="row">
          <button id="btnQ" class="bigBtn">Domanda</button>
          <button id="btnT" class="bigBtn secondary">Verità</button>
        </div>
      </div>
      <div id="loserUI" style="display:none">
        <p>Attendi che l'avversario effettui la sua azione…</p>
      </div>
      <div id="post" class="panel"></div>
    </section>
  </main>

  <script>
  (function(){
    const {qs, params} = DV;
    const gid=params().get('game'); const role=params().get('role'); // p1/p2

    DB.ref('games/'+gid).on('value', s=>{
      const d=s.val()||{};
      if(d.phase!=='action'){ return; }
      const turn=d.turn||1; const r=d.rounds && d.rounds['turn_'+turn];
      if(!r){ qs('#info').textContent='Nessun esito.'; return; }
      if(r.winner===null){
        qs('#info').textContent='Pareggio: si passa direttamente al prossimo turno.';
        nextBtn();
        return;
      }
      const winnerRole=r.winner;
      qs('#info').textContent='Vincitore: '+(winnerRole==='p1'?(d.player1?.name||'Giocatore 1'):(d.player2?.name||'Giocatore 2'));
      if(role===winnerRole){
        qs('#winnerUI').style.display='block'; qs('#loserUI').style.display='none';
      } else {
        qs('#winnerUI').style.display='none'; qs('#loserUI').style.display='block';
      }
    });

    function nextBtn(){
      const post=qs('#post'); post.innerHTML='';
      const b=document.createElement('button'); b.textContent='Avvia turno successivo';
      b.onclick=()=>{
        DB.ref('games/'+gid).transaction(data=>{
          if(!data) return data;
          data.turn=(data.turn||1)+1;
          data.tokens_p1 = (data.tokens_p1||0) + 2;
          data.tokens_p2 = (data.tokens_p2||0) + 2;
          data.bets={}; data.phase='betting'; data.betDeadlineAt=Date.now()+15000; return data;
        });
        location.href='bet.html?game='+gid+'&role='+role;
      };
      post.appendChild(b);
    }

    qs('#btnQ').addEventListener('click', ()=>{ qs('#post').textContent='Hai scelto: Domanda (stub).'; nextBtn(); });
    qs('#btnT').addEventListener('click', ()=>{ qs('#post').textContent='Hai scelto: Verità (stub).'; nextBtn(); });
  })();
  </script>
</body>
</html>
